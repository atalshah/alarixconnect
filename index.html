<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Alarix Connect - Ultimate</title>
    
    <!-- 1. Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <!-- 3. Firebase SDK (Compat) -->
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.8.1/firebase-database-compat.js"></script>

    <style>
        /* Core Styles */
        body { font-family: 'Segoe UI', sans-serif; -webkit-tap-highlight-color: transparent; user-select: none; }
        
        /* Animations */
        .fade-in { animation: fadeIn 0.3s ease-in-out forwards; }
        .pop-in { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8) translateY(20px); } to { opacity: 1; transform: scale(1) translateY(0); } }
        
        /* Video Mirroring */
        video { transform: scaleX(-1); background: #000; object-fit: cover; }
        
        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #111827; }
        ::-webkit-scrollbar-thumb { background: #374151; border-radius: 10px; }
    </style>
</head>
<body class="bg-gray-900 h-screen w-screen overflow-hidden text-gray-200 relative">

    <!-- AUDIO ASSETS -->
    <audio id="audio-ringtone" loop src="https://assets.mixkit.co/active_storage/sfx/1359/1359-preview.mp3"></audio>
    <audio id="audio-notify" src="https://assets.mixkit.co/active_storage/sfx/2869/2869-preview.mp3"></audio>

    <!-- CUSTOM ANIMATED MODAL (Replaces Alerts/Prompts/Confirms) -->
    <div id="custom-modal" class="hidden fixed inset-0 z-[100] bg-black/80 flex items-center justify-center p-4 backdrop-blur-sm transition-opacity">
        <div class="bg-gray-800 rounded-2xl shadow-2xl border border-gray-600 p-6 w-full max-w-sm pop-in" id="custom-modal-content">
            <h3 id="custom-modal-title" class="text-white font-bold text-lg mb-2">Title</h3>
            <p id="custom-modal-desc" class="text-gray-400 text-sm mb-4">Description goes here</p>
            <input type="text" id="custom-modal-input" class="hidden w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-3 mb-5 outline-none focus:border-blue-500 transition">
            <div class="flex gap-3 justify-end">
                <button id="custom-modal-cancel" class="hidden px-5 py-2 rounded-xl text-sm font-bold text-gray-400 hover:text-white hover:bg-gray-700 transition">Cancel</button>
                <button id="custom-modal-ok" class="px-5 py-2 rounded-xl text-sm font-bold bg-blue-600 text-white hover:bg-blue-700 shadow-lg transition transform hover:scale-105">OK</button>
            </div>
        </div>
    </div>

    <!-- 1. SPLASH SCREEN -->
    <div id="screen-splash" class="absolute inset-0 z-[90] flex flex-col items-center justify-center bg-gray-900">
        <div class="relative w-24 h-24 bg-blue-600 rounded-2xl flex items-center justify-center shadow-blue-500/50 shadow-2xl mb-6 animate-bounce">
            <span class="text-6xl font-black text-white">A</span>
            <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-gray-800 rounded-full flex items-center justify-center border-2 border-blue-500">
                <i class="fas fa-lock text-xs text-blue-400"></i>
            </div>
        </div>
        <h1 class="text-2xl font-bold tracking-[5px] text-white">ALARIX</h1>
        <p class="text-[10px] text-gray-500 mt-2 uppercase tracking-widest"><i class="fas fa-shield-alt mr-1"></i> End-to-End Encrypted</p>
    </div>

    <!-- 2. AUTH SCREEN -->
    <div id="screen-auth" class="hidden absolute inset-0 z-50 bg-black/80 flex items-center justify-center p-4 backdrop-blur-md">
        <div class="w-full max-w-md bg-gray-800 rounded-2xl shadow-2xl border border-gray-700 p-6 fade-in">
            <!-- Tabs -->
            <div class="flex mb-6 bg-gray-700 rounded-lg p-1">
                <button onclick="switchAuth('login')" id="tab-login" class="flex-1 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow">Login</button>
                <button onclick="switchAuth('signup')" id="tab-signup" class="flex-1 py-2 rounded-md text-sm font-bold text-gray-400">Sign Up</button>
            </div>

            <!-- Login -->
            <div id="form-login">
                <input type="text" id="login-user" class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-3 mb-4 outline-none focus:border-blue-500" placeholder="Username (e.g. john_alrx)">
                <input type="password" id="login-pass" class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-3 mb-6 outline-none" placeholder="Password">
                <button onclick="handleLogin()" id="btn-login" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-xl transition">Login</button>
            </div>

            <!-- Signup -->
            <div id="form-signup" class="hidden">
                <div class="flex flex-col items-center mb-4">
                    <div class="w-20 h-20 rounded-full border-2 border-gray-600 overflow-hidden relative bg-gray-700">
                        <img id="preview-avatar" src="https://i.ibb.co/51y8P5h/default-avatar.png" class="w-full h-full object-cover">
                        <input type="file" id="input-profile-file" class="absolute inset-0 opacity-0 cursor-pointer" accept="image/*">
                    </div>
                    <p class="text-[10px] text-gray-500 mt-1">Upload Photo</p>
                </div>
                <input type="text" id="signup-user" class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-3 mb-3 outline-none" placeholder="Username (must end in 'alrx')">
                <input type="password" id="signup-pass" class="w-full bg-gray-900 border border-gray-600 text-white rounded-lg p-3 mb-4 outline-none" placeholder="Password">
                <button onclick="handleSignup()" id="btn-signup" class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-3 rounded-xl transition">Create Account</button>
            </div>
            <p id="auth-error" class="text-red-400 text-xs text-center mt-4 h-5"></p>
        </div>
    </div>

    <!-- 3. HOME SCREEN -->
    <div id="screen-home" class="hidden absolute inset-0 bg-gray-900 flex flex-col z-10">
        <!-- Header -->
        <div class="bg-gray-800 border-b border-gray-700 p-4 flex justify-between items-center shadow-md">
            <div class="flex items-center gap-3">
                <img id="home-avatar" src="" class="w-10 h-10 rounded-full object-cover border border-gray-600">
                <div>
                    <h3 id="home-username" class="font-bold text-sm text-white"></h3>
                    <p class="text-[10px] text-green-400">Online</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="createGroup()" class="w-9 h-9 rounded-full bg-gray-700 text-green-400 hover:bg-green-600 hover:text-white transition flex items-center justify-center" title="Create Group"><i class="fas fa-users"></i></button>
                <button onclick="openSearch()" class="w-9 h-9 rounded-full bg-gray-700 text-white hover:bg-blue-600 transition flex items-center justify-center"><i class="fas fa-search"></i></button>
                <button onclick="logout()" class="w-9 h-9 rounded-full bg-gray-700 text-red-400 hover:bg-red-900 transition flex items-center justify-center"><i class="fas fa-power-off"></i></button>
            </div>
        </div>

        <!-- Recent Chats List -->
        <div class="flex-1 overflow-y-auto" id="recent-chats-list">
            <!-- Dynamic Content -->
            <div class="flex flex-col items-center justify-center h-full text-gray-600">
                <i class="fas fa-comments text-4xl mb-3 opacity-20"></i>
                <p class="text-sm">No recent chats</p>
            </div>
        </div>
    </div>

    <!-- 4. SEARCH SECTION -->
    <div id="screen-search" class="hidden absolute inset-0 z-20 bg-gray-900 flex flex-col">
        <div class="p-4 bg-gray-800 border-b border-gray-700 flex gap-3">
            <button onclick="closeSearch()" class="text-gray-400"><i class="fas fa-arrow-left"></i></button>
            <input type="text" id="search-input" class="flex-1 bg-transparent outline-none text-white placeholder-gray-500" placeholder="Search username...">
            <button onclick="executeSearch()" class="text-blue-500 font-bold">Find</button>
        </div>
        <div id="search-results" class="flex-1 p-4 overflow-y-auto"></div>
    </div>

    <!-- 5. CHAT SCREEN -->
    <div id="screen-chat" class="hidden absolute inset-0 bg-gray-900 flex flex-col z-30 transition-transform duration-300 transform translate-x-full">
        <!-- Header -->
        <div class="bg-gray-800 border-b border-gray-700 p-3 flex items-center justify-between shadow-md z-10">
            <div class="flex items-center gap-3">
                <button onclick="closeChat()" class="text-gray-400 p-2"><i class="fas fa-arrow-left"></i></button>
                <img id="chat-header-img" class="w-10 h-10 rounded-full object-cover bg-gray-700">
                <div>
                    <h3 id="chat-header-name" class="font-bold text-sm text-white truncate max-w-[120px]">User</h3>
                    <div class="flex items-center gap-1">
                        <i class="fas fa-lock text-[8px] text-gray-500"></i>
                        <p class="text-[10px] text-gray-400">E2E Encrypted</p>
                    </div>
                </div>
            </div>
            <div class="flex gap-2">
                <button id="btn-add-member" onclick="addGroupMember()" class="hidden w-9 h-9 rounded-full bg-gray-700 text-green-400 hover:bg-gray-600"><i class="fas fa-user-plus"></i></button>
                <button id="btn-call-audio" onclick="startCall('audio')" class="w-9 h-9 rounded-full bg-gray-700 text-blue-400 hover:bg-gray-600"><i class="fas fa-phone"></i></button>
                <button id="btn-call-video" onclick="startCall('video')" class="w-9 h-9 rounded-full bg-gray-700 text-blue-400 hover:bg-gray-600"><i class="fas fa-video"></i></button>
            </div>
        </div>

        <!-- Messages -->
        <div id="chat-messages" class="flex-1 overflow-y-auto p-4 flex flex-col bg-gray-900 pb-20 scroll-smooth"></div>

        <!-- Input -->
        <div class="absolute bottom-0 left-0 w-full p-3 bg-gray-800 border-t border-gray-700 flex gap-2 items-center z-10">
            <label class="w-10 h-10 rounded-full bg-gray-700 text-gray-400 hover:text-white flex items-center justify-center cursor-pointer">
                <i class="fas fa-image"></i>
                <input type="file" id="chat-image-input" class="hidden" accept="image/*">
            </label>
            
            <input type="text" id="chat-input" class="flex-1 bg-gray-700 text-white rounded-full px-4 py-3 text-sm outline-none placeholder-gray-400 focus:ring-1 focus:ring-blue-500" placeholder="Type message...">
            
            <button onclick="sendMessage('text')" class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center hover:bg-blue-700 active:scale-95 transition">
                <i class="fas fa-paper-plane text-sm"></i>
            </button>
        </div>
    </div>

    <!-- 6. MESSAGE OPTIONS -->
    <div id="msg-options" class="hidden fixed inset-0 z-[60] bg-black/70 flex items-end sm:items-center justify-center fade-in" onclick="closeMsgOptions()">
        <div class="bg-gray-800 w-full sm:w-80 rounded-t-2xl sm:rounded-2xl p-4 shadow-2xl border-t border-gray-700" onclick="event.stopPropagation()">
            <div class="w-10 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
            
            <!-- Reactions -->
            <div class="flex justify-between mb-6 px-4">
                <button onclick="reactToMsg('‚ù§Ô∏è')" class="text-2xl hover:scale-125 transition">‚ù§Ô∏è</button>
                <button onclick="reactToMsg('üòÇ')" class="text-2xl hover:scale-125 transition">üòÇ</button>
                <button onclick="reactToMsg('üòÆ')" class="text-2xl hover:scale-125 transition">üòÆ</button>
                <button onclick="reactToMsg('üëç')" class="text-2xl hover:scale-125 transition">üëç</button>
                <button onclick="reactToMsg('üò¢')" class="text-2xl hover:scale-125 transition">üò¢</button>
            </div>

            <!-- Actions -->
            <div class="space-y-2">
                <button id="opt-copy" onclick="copyMsgText()" class="w-full text-left p-3 rounded-lg hover:bg-gray-700 text-sm font-bold flex items-center gap-3"><i class="fas fa-copy text-blue-400"></i> Copy Text</button>
                <button id="opt-download" onclick="downloadImage()" class="w-full text-left p-3 rounded-lg hover:bg-gray-700 text-sm font-bold flex items-center gap-3 hidden"><i class="fas fa-download text-green-400"></i> Download Image</button>
                <button id="opt-delete" onclick="deleteMsg()" class="w-full text-left p-3 rounded-lg hover:bg-gray-700 text-sm font-bold flex items-center gap-3 text-red-400 hidden"><i class="fas fa-trash"></i> Delete For Everyone</button>
            </div>
        </div>
    </div>

    <!-- 7. CALL SCREEN -->
    <div id="screen-call" class="hidden fixed inset-0 z-[70] bg-black flex flex-col fade-in">
        <div class="relative flex-1">
            <video id="video-remote" class="w-full h-full object-cover" autoplay playsinline></video>
            <div class="absolute top-4 right-4 w-28 h-40 bg-gray-800 rounded-lg overflow-hidden border border-gray-600 shadow-2xl">
                <video id="video-local" class="w-full h-full object-cover" autoplay playsinline muted></video>
            </div>
            <div class="absolute top-10 left-4 bg-black/60 px-4 py-2 rounded-full border border-white/10">
                <span id="call-timer" class="text-white text-xs font-mono">00:00</span>
            </div>
        </div>
        <div class="bg-gray-900/90 p-6 flex justify-center items-center gap-8 pb-10">
            <button onclick="endCall()" class="w-16 h-16 rounded-full bg-red-600 hover:bg-red-700 text-white text-2xl flex items-center justify-center shadow-lg transition transform hover:scale-105"><i class="fas fa-phone-slash"></i></button>
        </div>
    </div>

    <!-- 8. INCOMING CALL -->
    <div id="incoming-call-modal" class="hidden fixed top-4 left-4 right-4 z-[80] bg-gray-800 rounded-xl shadow-2xl p-4 border-l-4 border-blue-500 animate-bounce">
        <div class="flex items-center justify-between">
            <div class="flex items-center gap-3">
                <div class="w-12 h-12 rounded-full bg-blue-900/50 flex items-center justify-center text-blue-400 text-xl animate-pulse"><i class="fas fa-phone"></i></div>
                <div><h4 class="font-bold text-white">Incoming Call...</h4><p id="incoming-caller-name" class="text-xs text-gray-400">User is calling</p></div>
            </div>
            <div class="flex gap-2">
                <button onclick="rejectIncomingCall()" class="bg-red-500/20 text-red-500 p-3 rounded-full"><i class="fas fa-times"></i></button>
                <button onclick="acceptIncomingCall()" class="bg-green-600 text-white p-3 rounded-full"><i class="fas fa-phone"></i></button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. SETUP & CUSTOM MODAL ---
        const firebaseConfig = {
            apiKey: "AIzaSyCogL9JFzyBEk9zp-IuruMKR9sRgXGF-Ac",
            authDomain: "alarix.firebaseapp.com",
            databaseURL: "https://alarix-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "alarix",
            storageBucket: "alarix.firebasestorage.app",
            messagingSenderId: "647856091661",
            appId: "1:647856091661:web:5eb4bfd361ca577dfadb44"
        };
        const IMG_BB_KEY = "1e9b151a1301a93017bfa29a913708cd";

        try { firebase.initializeApp(firebaseConfig); } catch(e) {}
        const db = firebase.database();

        let currentUser = null;
        let currentChatUser = null;
        let selectedMsgId = null; 
        let currentMessagesMap = {}; 

        // WebRTC Vars
        let localStream = null;
        let peerConnection = null;
        let callTimerInt = null;
        let incomingCallData = null;
        const rtcConfig = { iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] };
        
        const ringtone = document.getElementById('audio-ringtone');
        const notifSound = document.getElementById('audio-notify');

        // CUSTOM MODAL LOGIC
        function showModal({ title, desc, type = 'alert', placeholder = '', onOk }) {
            const modal = document.getElementById('custom-modal');
            const content = document.getElementById('custom-modal-content');
            
            document.getElementById('custom-modal-title').innerText = title;
            document.getElementById('custom-modal-desc').innerText = desc || '';
            
            const input = document.getElementById('custom-modal-input');
            const cancelBtn = document.getElementById('custom-modal-cancel');
            const okBtn = document.getElementById('custom-modal-ok');

            input.value = '';
            if(type === 'prompt') {
                input.classList.remove('hidden');
                input.placeholder = placeholder;
                setTimeout(() => input.focus(), 100);
            } else {
                input.classList.add('hidden');
            }

            if(type === 'alert') cancelBtn.classList.add('hidden');
            else cancelBtn.classList.remove('hidden');

            modal.classList.remove('hidden');
            content.classList.remove('scale-95');
            content.classList.add('pop-in');

            okBtn.onclick = () => {
                closeModal();
                if(type === 'prompt') onOk && onOk(input.value);
                else onOk && onOk();
            };
            cancelBtn.onclick = closeModal;
        }

        function closeModal() {
            const modal = document.getElementById('custom-modal');
            modal.classList.add('hidden');
        }

        // --- 2. ENCRYPTION ---
        function encrypt(text, key) {
            let result = "";
            for(let i=0; i<text.length; i++) {
                result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
            }
            return btoa(result);
        }

        function decrypt(encoded, key) {
            try {
                let text = atob(encoded);
                let result = "";
                for(let i=0; i<text.length; i++) {
                    result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
                }
                return result;
            } catch(e) { return "Encrypted Message"; }
        }

        function getChatId() {
            if (!currentChatUser) return null;
            if (currentChatUser.isGroup) return currentChatUser.uid;
            return [currentUser.uid, currentChatUser.uid].sort().join('_');
        }

        // --- 3. AUTHENTICATION & PUSH NOTIFICATIONS ---
        function switchAuth(mode) {
            const login = document.getElementById('form-login');
            const signup = document.getElementById('form-signup');
            const tLog = document.getElementById('tab-login');
            const tSign = document.getElementById('tab-signup');
            
            if(mode === 'login') {
                login.classList.remove('hidden'); signup.classList.add('hidden');
                tLog.className = "flex-1 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow";
                tSign.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-400";
            } else {
                signup.classList.remove('hidden'); login.classList.add('hidden');
                tSign.className = "flex-1 py-2 rounded-md text-sm font-bold bg-blue-600 text-white shadow";
                tLog.className = "flex-1 py-2 rounded-md text-sm font-bold text-gray-400";
            }
            document.getElementById('auth-error').innerText = "";
        }

        async function handleSignup() {
            const user = document.getElementById('signup-user').value.trim().toLowerCase();
            const pass = document.getElementById('signup-pass').value;
            const file = document.getElementById('input-profile-file').files[0];
            const err = document.getElementById('auth-error');

            if(!file || !user.endsWith('alrx') || pass.length < 5) return err.innerText = "Invalid inputs. Username must end in 'alrx'.";

            document.getElementById('btn-signup').innerText = "Processing...";

            db.ref('usernames/' + user).once('value', async snap => {
                if(snap.exists()) {
                    document.getElementById('btn-signup').innerText = "Create Account";
                    return err.innerText = "Username taken.";
                }

                const fd = new FormData(); fd.append("image", file);
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_KEY}`, { method: "POST", body: fd });
                const json = await res.json();
                const photoUrl = json.data.url;

                const uid = user + "_" + Date.now(); // Safe UID Generation
                const data = { username: user, pass, photo: photoUrl, uid };

                await db.ref('users/' + uid).set(data);
                await db.ref('usernames/' + user).set(uid);
                startSession(data);
            });
        }

        function handleLogin() {
            const user = document.getElementById('login-user').value.trim().toLowerCase();
            const pass = document.getElementById('login-pass').value;
            const err = document.getElementById('auth-error');

            if(!user || !pass) return err.innerText = "Enter credentials.";

            db.ref('usernames/' + user).once('value', snap => {
                if(!snap.exists()) return err.innerText = "User not found.";
                db.ref('users/' + snap.val()).once('value', uSnap => {
                    const uData = uSnap.val();
                    if(uData && uData.pass === pass) startSession(uData);
                    else err.innerText = "Wrong password.";
                });
            });
        }

        function startSession(user) {
            currentUser = user;
            if(!currentUser.uid) currentUser.uid = currentUser.username + "_" + Date.now();
            localStorage.setItem('alarix_ultimate_user', JSON.stringify(currentUser));

            document.getElementById('home-avatar').src = currentUser.photo;
            document.getElementById('home-username').innerText = currentUser.username;
            
            document.getElementById('screen-auth').classList.add('hidden');
            document.getElementById('screen-splash').classList.add('hidden');
            document.getElementById('screen-home').classList.remove('hidden');

            requestPermissions();
            listenForRecentChats();
            listenForIncomingCalls();
            listenForPushNotifications();
        }

        function requestPermissions() {
            if("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }
            navigator.mediaDevices.getUserMedia({video:true, audio:true})
                .then(s => s.getTracks().forEach(t=>t.stop()))
                .catch(e => console.log("Media perms delayed."));
        }

        function listenForPushNotifications() {
            // Monitor Recent Chats for new messages
            const notifyLogic = (snap) => {
                const data = snap.val();
                if (Date.now() - data.timestamp < 5000) { 
                    if (!currentChatUser || currentChatUser.uid !== snap.key) {
                        notifSound.play().catch(()=>{});
                        if ("Notification" in window && Notification.permission === "granted") {
                            new Notification(data.username, { body: data.lastMsg, icon: data.photo });
                        }
                    }
                }
            };
            db.ref(`recent/${currentUser.uid}`).on('child_changed', notifyLogic);
            db.ref(`recent/${currentUser.uid}`).on('child_added', notifyLogic);
        }

        function logout() {
            localStorage.removeItem('alarix_ultimate_user');
            location.reload();
        }

        window.onload = () => {
            const saved = localStorage.getItem('alarix_ultimate_user');
            setTimeout(() => {
                if(saved) startSession(JSON.parse(saved));
                else {
                    document.getElementById('screen-splash').classList.add('hidden');
                    document.getElementById('screen-auth').classList.remove('hidden');
                }
            }, 2000);
        };

        // --- 4. GROUPS AND HOME ---
        function listenForRecentChats() {
            const list = document.getElementById('recent-chats-list');
            db.ref(`recent/${currentUser.uid}`).orderByChild('timestamp').on('value', snap => {
                if(!snap.exists()) return list.innerHTML = `<div class="flex flex-col items-center justify-center h-full text-gray-600"><i class="fas fa-comments text-4xl mb-3 opacity-20"></i><p class="text-sm">No recent chats</p></div>`;
                
                list.innerHTML = "";
                const chatsArray = [];
                snap.forEach(child => { chatsArray.push({key: child.key, data: child.val()}); });
                
                chatsArray.reverse().forEach(item => {
                    const chatInfo = item.data;
                    const otherUid = item.key;
                    
                    const div = document.createElement('div');
                    div.className = "flex items-center gap-3 p-4 border-b border-gray-800 hover:bg-gray-800 cursor-pointer transition";
                    div.innerHTML = `
                        <div class="relative">
                            <img src="${chatInfo.photo}" class="w-12 h-12 rounded-full object-cover border border-gray-600">
                            ${chatInfo.isGroup ? '<div class="absolute bottom-0 right-0 bg-gray-800 rounded-full w-4 h-4 flex items-center justify-center border border-gray-600"><i class="fas fa-users text-[8px] text-green-400"></i></div>' : ''}
                        </div>
                        <div class="flex-1 overflow-hidden">
                            <h4 class="font-bold text-white text-sm truncate">${chatInfo.username}</h4>
                            <p class="text-xs text-gray-400 truncate w-full">${chatInfo.lastMsg}</p>
                        </div>
                    `;
                    div.onclick = () => {
                        if (chatInfo.isGroup) {
                            db.ref(`groups/${otherUid}`).once('value', gSnap => {
                                let gData = gSnap.val();
                                if(!gData) gData = { uid: otherUid, username: chatInfo.username, photo: chatInfo.photo, isGroup: true };
                                openChat(gData);
                            });
                        } else {
                            db.ref(`users/${otherUid}`).once('value', uSnap => {
                                let uData = uSnap.val();
                                if(!uData) uData = { uid: otherUid, username: chatInfo.username, photo: chatInfo.photo }; // User not exists fix
                                openChat(uData);
                            });
                        }
                    };
                    list.appendChild(div);
                });
            });
        }

        function createGroup() {
            showModal({
                title: "Create Group",
                desc: "Enter a name for your new group:",
                type: "prompt",
                placeholder: "Friends Group",
                onOk: async (name) => {
                    if(!name || !name.trim()) return;
                    const groupId = 'group_' + Date.now() + '_' + currentUser.uid.substring(0, 5);
                    
                    const groupData = {
                        uid: groupId, username: name.trim(), photo: 'https://cdn-icons-png.flaticon.com/512/615/615075.png', 
                        isGroup: true, memberCount: 1, admin: currentUser.uid, members: { [currentUser.uid]: true }
                    };

                    await db.ref('groups/' + groupId).set(groupData);
                    await db.ref(`recent/${currentUser.uid}/${groupId}`).update({
                        username: groupData.username, photo: groupData.photo, lastMsg: 'You created this group',
                        timestamp: firebase.database.ServerValue.TIMESTAMP, isGroup: true
                    });
                    openChat(groupData);
                }
            });
        }

        function addGroupMember() {
            if(!currentChatUser || !currentChatUser.isGroup) return;
            
            showModal({
                title: "Add Member",
                desc: "Enter exact username to add (e.g., ali_alrx):",
                type: "prompt",
                placeholder: "Username...",
                onOk: async (uname) => {
                    if(!uname || !uname.trim()) return;

                    const snap = await db.ref('usernames/' + uname.trim().toLowerCase()).once('value');
                    if(!snap.exists()) return showModal({title: "Error", desc: "User not found!"});
                    const newUid = snap.val();

                    const gSnap = await db.ref('groups/' + currentChatUser.uid).once('value');
                    const gData = gSnap.val();
                    if(!gData) return showModal({title: "Error", desc: "Group error."});

                    if(gData.memberCount >= 100) return showModal({title: "Limit Reached", desc: "Max 100 members allowed!"});
                    if(gData.members && gData.members[newUid]) return showModal({title: "Notice", desc: "User is already in the group."});

                    await db.ref('groups/' + currentChatUser.uid + '/members/' + newUid).set(true);
                    await db.ref('groups/' + currentChatUser.uid + '/memberCount').set(gData.memberCount + 1);

                    await db.ref(`recent/${newUid}/${currentChatUser.uid}`).update({
                        username: gData.username, photo: gData.photo, lastMsg: `${currentUser.username} added you`,
                        timestamp: firebase.database.ServerValue.TIMESTAMP, isGroup: true
                    });

                    showModal({title: "Success", desc: `User ${uname} has been added to the group!`});
                }
            });
        }

        // --- 5. SEARCH ---
        function openSearch() {
            document.getElementById('screen-search').classList.remove('hidden');
            document.getElementById('search-input').focus();
        }

        function closeSearch() {
            document.getElementById('screen-search').classList.add('hidden');
        }

        function executeSearch() {
            const q = document.getElementById('search-input').value.trim().toLowerCase();
            const resBox = document.getElementById('search-results');
            resBox.innerHTML = '<p class="text-center text-gray-500 mt-5">Searching...</p>';

            db.ref('usernames/' + q).once('value', snap => {
                resBox.innerHTML = '';
                if(snap.exists()) {
                    const uid = snap.val();
                    if(uid === currentUser.uid) return resBox.innerHTML = '<p class="text-center text-gray-500 mt-5">You found yourself!</p>';
                    
                    db.ref('users/' + uid).once('value', uSnap => {
                        const user = uSnap.val();
                        if(!user) return;
                        const div = document.createElement('div');
                        div.className = "flex items-center gap-3 p-3 bg-gray-800 rounded-lg cursor-pointer hover:bg-gray-700 transition";
                        div.innerHTML = `
                            <img src="${user.photo}" class="w-10 h-10 rounded-full object-cover">
                            <div><h4 class="font-bold text-white">${user.username}</h4><p class="text-xs text-blue-400">Tap to chat</p></div>
                        `;
                        div.onclick = () => { closeSearch(); openChat(user); };
                        resBox.appendChild(div);
                    });
                } else {
                    resBox.innerHTML = '<p class="text-center text-gray-500 mt-5">User not found</p>';
                }
            });
        }

        // --- 6. CHAT LOGIC ---
        function openChat(userObj) {
            currentChatUser = userObj;
            
            document.getElementById('chat-header-img').src = currentChatUser.photo;
            document.getElementById('chat-header-name').innerText = currentChatUser.username;
            
            const isGrp = currentChatUser.isGroup === true;
            document.getElementById('btn-add-member').classList.toggle('hidden', !isGrp);
            document.getElementById('btn-call-audio').classList.toggle('hidden', isGrp);
            document.getElementById('btn-call-video').classList.toggle('hidden', isGrp);

            document.getElementById('screen-chat').classList.remove('hidden');
            setTimeout(() => document.getElementById('screen-chat').classList.remove('translate-x-full'), 10);

            const chatId = getChatId();
            const box = document.getElementById('chat-messages');
            box.innerHTML = '';
            currentMessagesMap = {}; 

            const chatRef = db.ref('chats/' + chatId);
            chatRef.off(); 

            chatRef.limitToLast(100).on('child_added', snap => {
                const msg = snap.val();
                currentMessagesMap[snap.key] = msg;
                box.insertAdjacentHTML('beforeend', createMessageHTML(snap.key, msg));
                box.scrollTop = box.scrollHeight;
            });

            chatRef.limitToLast(100).on('child_changed', snap => {
                const msg = snap.val();
                currentMessagesMap[snap.key] = msg;
                const oldDiv = document.getElementById('msg-' + snap.key);
                if(oldDiv) oldDiv.outerHTML = createMessageHTML(snap.key, msg);
            });
        }

        function closeChat() {
            document.getElementById('screen-chat').classList.add('translate-x-full');
            setTimeout(() => {
                document.getElementById('screen-chat').classList.add('hidden');
                currentChatUser = null;
                const chatId = getChatId();
                if(chatId) db.ref('chats/' + chatId).off();
            }, 300);
        }

        function createMessageHTML(key, msg) {
            const chatId = getChatId();
            const decryptedText = decrypt(msg.text, chatId);
            const isMe = msg.sender === currentUser.uid;

            let contentHtml = '';
            if(msg.type === 'image') {
                contentHtml = `<img src="${decryptedText}" class="rounded-lg max-w-[200px] border border-gray-600 mb-1">`;
            } else {
                contentHtml = `<span class="break-words">${msg.isDeleted ? '<i class="text-gray-400 text-[11px]">Deleted message</i>' : decryptedText}</span>`;
            }

            const dots = `<button onclick="openMsgOptions('${key}')" class="absolute top-1 ${isMe ? '-left-8' : '-right-8'} text-gray-400 opacity-0 group-hover:opacity-100 transition p-2"><i class="fas fa-ellipsis-v"></i></button>`;

            let reactionHtml = '';
            if(msg.reactions) {
                const counts = {};
                for(let uid in msg.reactions) {
                    let r = msg.reactions[uid];
                    counts[r] = (counts[r] || 0) + 1;
                }
                let rInner = '';
                for(let emoji in counts) rInner += `<span class="bg-gray-800 rounded-full px-2 py-0.5 text-[11px] border border-gray-600 mr-1 shadow-md">${emoji} ${counts[emoji]}</span>`;
                reactionHtml = `<div class="absolute -bottom-3 ${isMe ? 'right-2' : 'left-2'} flex flex-row z-10 fade-in">${rInner}</div>`;
            }

            const mb = msg.reactions ? 'mb-6' : 'mb-3';

            return `
                <div class="flex w-full ${isMe ? 'justify-end' : 'justify-start'} ${mb} relative group" id="msg-${key}">
                    <div class="relative max-w-[75%]">
                        ${dots}
                        <div class="p-3 rounded-2xl text-sm shadow-md ${isMe ? 'bg-blue-600 text-white rounded-tr-none' : 'bg-gray-700 text-gray-200 rounded-tl-none'} relative">
                            ${contentHtml}
                            <p class="text-[9px] opacity-60 text-right mt-1">${new Date(msg.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})}</p>
                        </div>
                        ${reactionHtml}
                    </div>
                </div>
            `;
        }

        document.getElementById('chat-image-input').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if(!file) return;

            const btn = document.querySelector('.fa-image');
            btn.className = "fas fa-spinner fa-spin text-blue-400";

            const fd = new FormData(); fd.append("image", file);
            try {
                const res = await fetch(`https://api.imgbb.com/1/upload?key=${IMG_BB_KEY}`, { method: "POST", body: fd });
                const json = await res.json();
                if(json.success) sendMessage('image', json.data.url);
            } catch(err) { showModal({title: "Error", desc: "Image upload failed"}); }
            
            btn.className = "fas fa-image";
            e.target.value = ""; 
        });

        async function sendMessage(type, content = null) {
            const input = document.getElementById('chat-input');
            let text = content || input.value.trim();
            if(!text) return;

            const chatId = getChatId();
            const encryptedText = encrypt(text, chatId);

            db.ref('chats/' + chatId).push({
                sender: currentUser.uid, text: encryptedText, type: type, timestamp: firebase.database.ServerValue.TIMESTAMP
            });

            const lastMsgLabel = type === 'image' ? 'üì∑ Photo' : (currentChatUser.isGroup ? `${currentUser.username}: Msg` : 'Encrypted Msg');

            if (currentChatUser.isGroup) {
                db.ref(`groups/${currentChatUser.uid}/members`).once('value', mSnap => {
                    const members = mSnap.val();
                    for(let mUid in members) {
                        db.ref(`recent/${mUid}/${currentChatUser.uid}`).update({
                            username: currentChatUser.username, photo: currentChatUser.photo, lastMsg: lastMsgLabel,
                            timestamp: firebase.database.ServerValue.TIMESTAMP, isGroup: true
                        });
                    }
                });
            } else {
                db.ref(`recent/${currentUser.uid}/${currentChatUser.uid}`).update({
                    username: currentChatUser.username, photo: currentChatUser.photo, lastMsg: lastMsgLabel, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
                db.ref(`recent/${currentChatUser.uid}/${currentUser.uid}`).update({
                    username: currentUser.username, photo: currentUser.photo, lastMsg: lastMsgLabel, timestamp: firebase.database.ServerValue.TIMESTAMP
                });
            }

            if(type === 'text') input.value = '';
        }

        // --- 7. MESSAGE OPTIONS & REACTIONS ---
        function openMsgOptions(id) {
            const msg = currentMessagesMap[id];
            if(!msg) return;

            selectedMsgId = id;
            const isMe = msg.sender === currentUser.uid;
            
            // Re-added and verified copy button functionality
            document.getElementById('opt-copy').classList.toggle('hidden', msg.type === 'image' || msg.isDeleted);
            document.getElementById('opt-download').classList.toggle('hidden', msg.type !== 'image' || msg.isDeleted);
            document.getElementById('opt-delete').classList.toggle('hidden', !isMe || msg.isDeleted);

            document.getElementById('msg-options').classList.remove('hidden');
        }

        function closeMsgOptions() {
            document.getElementById('msg-options').classList.add('hidden');
            selectedMsgId = null;
        }

        function reactToMsg(emoji) {
            if(!selectedMsgId) return;
            const chatId = getChatId();
            db.ref(`chats/${chatId}/${selectedMsgId}/reactions/${currentUser.uid}`).set(emoji);
            closeMsgOptions();
        }

        function copyMsgText() {
            const msg = currentMessagesMap[selectedMsgId];
            if(msg) {
                const decryptedText = decrypt(msg.text, getChatId());
                navigator.clipboard.writeText(decryptedText).then(() => {
                    showModal({title: "Copied!", desc: "Message text copied to clipboard."});
                });
            }
            closeMsgOptions();
        }

        function downloadImage() {
            const msg = currentMessagesMap[selectedMsgId];
            if(msg) {
                const decryptedUrl = decrypt(msg.text, getChatId());
                const link = document.createElement('a');
                link.href = decryptedUrl;
                link.target = "_blank";
                link.download = "alarix_img.jpg";
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }
            closeMsgOptions();
        }

        function deleteMsg() {
            showModal({
                title: "Delete Message",
                desc: "Are you sure you want to delete this for everyone?",
                type: "confirm",
                onOk: () => {
                    const chatId = getChatId();
                    const encryptedDel = encrypt("Deleted message", chatId);
                    db.ref(`chats/${chatId}/${selectedMsgId}`).update({ 
                        text: encryptedDel, isDeleted: true, type: 'text', reactions: null 
                    });
                    closeMsgOptions();
                }
            });
        }

        // --- 8. CALLING ---
        async function startCall(type) {
            if(!currentChatUser || currentChatUser.isGroup) return;
            try {
                localStream = await navigator.mediaDevices.getUserMedia({ video: type === 'video', audio: true });
                document.getElementById('video-local').srcObject = localStream;
                if(type==='audio') document.getElementById('video-local').srcObject = null;
            } catch(e) { return showModal({title: "Permission Denied", desc: "Please allow Camera/Microphone!"}); }

            document.getElementById('screen-call').classList.remove('hidden');
            peerConnection = new RTCPeerConnection(rtcConfig);
            
            localStream.getTracks().forEach(track => peerConnection.addTrack(track, localStream));
            
            peerConnection.ontrack = e => {
                if(e.streams && e.streams[0]) document.getElementById('video-remote').srcObject = e.streams[0];
            };

            peerConnection.onicecandidate = e => {
                if(e.candidate) db.ref(`calls/${currentChatUser.uid}/candidate`).push(e.candidate.toJSON());
            };

            const offer = await peerConnection.createOffer();
            await peerConnection.setLocalDescription(offer);

            db.ref(`calls/${currentChatUser.uid}/incoming`).set({
                caller: currentUser.uid, callerName: currentUser.username, type: type, sdp: offer.sdp, offerType: offer.type
            });

            db.ref(`calls/${currentChatUser.uid}/answer`).on('value', snap => {
                const val = snap.val();
                if(val && !peerConnection.currentRemoteDescription) {
                    peerConnection.setRemoteDescription(new RTCSessionDescription(val));
                    startTimer();
                }
            });
            
            db.ref(`calls/${currentChatUser.uid}/answerCandidate`).on('child_added', s => {
                if(peerConnection.remoteDescription) peerConnection.addIceCandidate(new RTCIceCandidate(s.val()));
            });
        }

        function listenForIncomingCalls() {
            db.ref(`calls/${currentUser.uid}/incoming`).on('value', snap => {
                const d = snap.val();
                if(d) {
                    incomingCallData = d;
                    document.getElementById('incoming-caller-name').innerText = d.callerName;
                    document.getElementById('incoming-call-modal').classList.remove('hidden');
                    ringtone.play().catch(()=>{});
                } else {
                    document.getElementById('incoming-call-modal').classList.add('hidden');
                    ringtone.pause();
                }
            });
        }

        async function acceptIncomingCall() {
            ringtone.pause();
            document.getElementById('incoming-call-modal').classList.add('hidden');
            
            const isVideo = incomingCallData.type === 'video';
            localStream = await navigator.mediaDevices.getUserMedia({ video: isVideo, audio: true });
            document.getElementById('video-local').srcObject = localStream;
            if(!isVideo) document.getElementById('video-local').srcObject = null;
            document.getElementById('screen-call').classList.remove('hidden');

            peerConnection = new RTCPeerConnection(rtcConfig);
            localStream.getTracks().forEach(t => peerConnection.addTrack(t, localStream));
            peerConnection.ontrack = e => document.getElementById('video-remote').srcObject = e.streams[0];
            peerConnection.onicecandidate = e => {
                if(e.candidate) db.ref(`calls/${currentUser.uid}/answerCandidate`).push(e.candidate.toJSON());
            };

            db.ref(`calls/${incomingCallData.caller}/candidate`).on('child_added', s => {
                if(peerConnection) peerConnection.addIceCandidate(new RTCIceCandidate(s.val()));
            });

            await peerConnection.setRemoteDescription(new RTCSessionDescription({type: incomingCallData.offerType, sdp: incomingCallData.sdp}));
            const ans = await peerConnection.createAnswer();
            await peerConnection.setLocalDescription(ans);
            
            db.ref(`calls/${currentUser.uid}/answer`).set({type: ans.type, sdp: ans.sdp});
            startTimer();
        }

        function rejectIncomingCall() {
            ringtone.pause();
            document.getElementById('incoming-call-modal').classList.add('hidden');
            db.ref(`calls/${currentUser.uid}/incoming`).remove();
        }

        function endCall() {
            if(localStream) localStream.getTracks().forEach(t => t.stop());
            if(peerConnection) peerConnection.close();
            document.getElementById('screen-call').classList.add('hidden');
            clearInterval(callTimerInt);
            
            if(currentChatUser) db.ref(`calls/${currentChatUser.uid}`).remove();
            db.ref(`calls/${currentUser.uid}`).remove();
            
            location.reload();
        }

        function startTimer() {
            let sec = 0; clearInterval(callTimerInt);
            callTimerInt = setInterval(() => {
                sec++;
                const m = Math.floor(sec/60).toString().padStart(2,'0');
                const s = (sec%60).toString().padStart(2,'0');
                document.getElementById('call-timer').innerText = `${m}:${s}`;
            }, 1000);
        }

    </script>
</body>
</html>
